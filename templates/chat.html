<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='gemini.png') }}"
    />
    <title>MediChat</title>

    <!-- Google Icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
    />

    <!-- Styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <style>
      /* Minimal helpers in case style.css lacks these */
      .topbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: flex-end;
        padding: 0.75rem 1rem;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 0.45rem 0.75rem;
        border-radius: 0.6rem;
        cursor: pointer;
        background: #fff;
      }
      .btn.primary {
        background: #0ea5e9;
        color: #412c2c;
        border-color: #0ea5e9;
      }
      .btn.ghost {
        background: transparent;
      }
      .muted {
        opacity: 0.7;
        font-size: 0.9rem;
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        place-items: center;
        z-index: 50;
      }
      .modal {
        background: #fff;
        color: #111;
        width: min(420px, 92vw);
        border-radius: 1rem;
        padding: 1.25rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      .modal h3 {
        margin: 0.25rem 0 1rem;
      }
      .modal form {
        display: grid;
        gap: 0.75rem;
      }
      .modal input {
        padding: 0.6rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.6rem;
        font-size: 1rem;
      }
      .modal .actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 0.25rem;
      }
      .chat-item {
        padding: 0.65rem 1rem;
      }
      .chat-item.user {
        text-align: right;
      }
      .chat-item.assistant {
        text-align: left;
      }
      .bubble {
        display: inline-block;
        padding: 0.6rem 0.8rem;
        border-radius: 1rem;
        max-width: 75ch;
        text-align: left;
      }
      .user .bubble {
        background: #0ea5e9;
        color: #fff;
      }
      .assistant .bubble {
        background: #f1f5f9;
      }
      .loader {
        display: inline-block;
        padding: 0.6rem 0.8rem;
        border-radius: 1rem;
        background: #f1f5f9;
      }
    </style>
  </head>
  <body>
    <!-- Topbar -->
    <div class="topbar">
      <span class="muted" id="auth-status">Guest session</span>
      <button class="btn" id="login-btn">
        <span class="material-symbols-rounded">login</span> Login
      </button>
      <button class="btn" id="signup-btn">
        <span class="material-symbols-rounded">person_add</span> Sign up
      </button>
      <button class="btn" id="logout-btn" style="display:none">
        <span class="material-symbols-rounded">logout</span> Logout
      </button>
    </div>

    <!-- Header with suggestions -->
    <header class="header">
      <h1 class="title">Hello, there</h1>
      <p class="subtitle">How can I help you today?</p>

      <ul class="suggestion-list">
        <li class="suggestion">
          <h4 class="text">
            What are the early warning signs of diabetes I should watch for?
          </h4>
          <span class="icon material-symbols-rounded">draw</span>
        </li>
        <li class="suggestion">
          <h4 class="text">
            How can I improve my sleep quality for better overall health?
          </h4>
          <span class="icon material-symbols-rounded">lightbulb</span>
        </li>
        <li class="suggestion">
          <h4 class="text">
            What steps should I take if I’m experiencing persistent back pain?
          </h4>
          <span class="icon material-symbols-rounded">explore</span>
        </li>
        <li class="suggestion">
          <h4 class="text">
            What are some effective ways to boost my immune system naturally?
          </h4>
          <span class="icon material-symbols-rounded">code</span>
        </li>
      </ul>
    </header>

    <!-- Chat list -->
    <div class="chat-list" id="chat-list"></div>

    <!-- Typing area -->
    <div class="typing-area">
      <form action="#" class="typing-form" id="typing-form">
        <div class="input-wrapper">
          <input
            type="text"
            placeholder="Enter a prompt here"
            class="typing-input"
            id="typing-input"
            required
          />
          <button
            type="submit"
            id="send-message-button"
            class="icon material-symbols-rounded"
          >
            send
          </button>
        </div>
        <div class="action-buttons">
          <span id="theme-toggle-button" class="icon material-symbols-rounded"
            >light_mode</span
          >
          <span id="delete-chat-button" class="icon material-symbols-rounded"
            >delete</span
          >
        </div>
      </form>
      <p class="disclaimer-text">
        MediChat may display inaccurate info, including about symptoms and
        causes, so double-check its responses.
      </p>
    </div>

    <!-- Auth modal -->
    <div class="modal-backdrop" id="auth-modal">
      <div class="modal">
        <h3 id="auth-heading">Login</h3>
        <form id="auth-form">
          <input id="auth-email" type="email" placeholder="Email" required />
          <input
            id="auth-password"
            type="password"
            placeholder="Password"
            minlength="6"
            required
          />
          <div class="actions">
            <button type="button" class="btn" id="auth-cancel">Cancel</button>
            <button type="submit" class="btn primary" id="auth-submit">
              Continue
            </button>
          </div>
          <p class="muted" id="auth-hint">
            We'll set a secure cookie for your session.
          </p>
        </form>
      </div>
    </div>

    <!-- Script -->
    <script>
      // ------- Utility helpers -------
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const chatList = $("#chat-list");
      const typingForm = $("#typing-form");
      const typingInput = $("#typing-input");

      function appendMessage(role, text) {
        const row = document.createElement("div");
        row.className = `chat-item ${role}`;
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;
        row.appendChild(bubble);
        chatList.appendChild(row);
        chatList.scrollTop = chatList.scrollHeight;
        return row;
      }

      function appendLoader() {
        const row = document.createElement("div");
        row.className = "chat-item assistant";
        const bubble = document.createElement("div");
        bubble.className = "loader";
        bubble.textContent = "Thinking…";
        row.appendChild(bubble);
        chatList.appendChild(row);
        chatList.scrollTop = chatList.scrollHeight;
        return row;
      }

      function removeNode(el) {
        if (el && el.parentNode) el.parentNode.removeChild(el);
      }

      // ------- Chat send flow -------
      typingForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = typingInput.value.trim();
        if (!msg) return;

        appendMessage("user", msg);
        typingInput.value = "";
        typingInput.focus();

        const loader = appendLoader();

        try {
          const res = await fetch("/get", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ msg }),
          });
          if (!res.ok) throw new Error("Network error");
          const text = await res.text();
          removeNode(loader);
          appendMessage("assistant", text);
        } catch (err) {
          removeNode(loader);
          appendMessage("assistant", "⚠️ Sorry, something went wrong.");
          console.error(err);
        }
      });

      // ------- Suggestions click -------
      $$(".suggestion").forEach((el) => {
        el.addEventListener("click", () => {
          const q = $(".text", el)?.textContent?.trim() || "";
          typingInput.value = q;
          typingForm.dispatchEvent(new Event("submit"));
        });
      });

      // ------- Theme toggle & clear -------
      $("#theme-toggle-button").addEventListener("click", () => {
        document.body.classList.toggle("dark");
        localStorage.setItem(
          "theme",
          document.body.classList.contains("dark") ? "dark" : "light"
        );
      });

      $("#delete-chat-button").addEventListener("click", () => {
        chatList.innerHTML = "";
      });

      if (localStorage.getItem("theme") === "dark")
        document.body.classList.add("dark");

      // ------- Auth -------
      const authModal = $("#auth-modal");
      const authHeading = $("#auth-heading");
      const authForm = $("#auth-form");
      const authEmail = $("#auth-email");
      const authPassword = $("#auth-password");
      const authStatus = $("#auth-status");
      const loginBtn = $("#login-btn");
      const signupBtn = $("#signup-btn");
      const logoutBtn = $("#logout-btn");
      const authCancel = $("#auth-cancel");
      let authMode = "login";

      function openAuth(mode) {
        authMode = mode;
        authHeading.textContent = mode === "login" ? "Login" : "Create account";
        $("#auth-hint").textContent =
          mode === "login"
            ? "Enter your email and password to continue."
            : "We will create your account and sign you in.";
        authModal.style.display = "grid";
        authEmail.focus();
      }

      function closeAuth() {
        authModal.style.display = "none";
        authForm.reset();
      }

      loginBtn.addEventListener("click", () => openAuth("login"));
      signupBtn.addEventListener("click", () => openAuth("signup"));
      authCancel.addEventListener("click", () => closeAuth());

      logoutBtn.addEventListener("click", async () => {
        try {
          const res = await fetch("/logout", { method: "POST" });
          if (!res.ok) throw new Error("Logout failed");
          localStorage.removeItem("loggedIn");
          localStorage.removeItem("authEmail");
          reflectAuthUI();
        } catch (e) {
          console.error(e);
          alert("Could not log out.");
        }
      });

      authForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = authEmail.value.trim();
        const password = authPassword.value.trim();
        if (!email || !password) return;

        try {
          const endpoint = authMode === "login" ? "/login" : "/signup";
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Auth error");

          if (authMode === "login") {
            localStorage.setItem("loggedIn", "1");
            localStorage.setItem("authEmail", email);
            reflectAuthUI();
          } else {
            alert("Signup successful. Check your email for confirmation, then log in.");
          }
          closeAuth();
        } catch (err) {
          console.error(err);
          alert(err.message || "Authentication failed.");
        }
      });

      function reflectAuthUI() {
        const loggedIn = localStorage.getItem("loggedIn") === "1";
        authStatus.textContent = loggedIn
          ? `Logged in${localStorage.getItem("authEmail") ? " as " + localStorage.getItem("authEmail") : ""}`
          : "Guest session";
        loginBtn.style.display = loggedIn ? "none" : "";
        signupBtn.style.display = loggedIn ? "none" : "";
        logoutBtn.style.display = loggedIn ? "" : "none";
      }

      reflectAuthUI();
    </script>
  </body>
</html>
